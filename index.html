async function generateNewQR() {
    try {
        // Fetch accurate time with retries
        const accurateTime = await fetchAccurateTimeWithRetry();

        // Calculate timestamp based on 10-second windows
        const timestamp = Math.floor(accurateTime.getTime() / 10000); // 10-second windows
        console.log('Generating QR Code with timestamp:', timestamp);

        const payload = {
            t: timestamp,
            s: currentSessionId,
            h: simpleHash(`${timestamp}${currentSessionId}${SECRET_PHRASE}`)
        };
        const token = btoa(JSON.stringify(payload)).replace(/=+$/, '');

        console.log('QR Payload:', payload);
        console.log('QR Token:', token);

        // Generate QR Code
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: token,
            width: 250,
            height: 250,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    } catch (error) {
        // Display error message to the user
        errorMessage.textContent = 'حدث خطأ في الحصول على الوقت الدقيق بعد عدة محاولات. يرجى التحقق من اتصال الإنترنت وإعادة المحاولة.';
        console.error('Final Error:', error);
    }
}
