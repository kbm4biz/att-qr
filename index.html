<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class QR Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            text-align: center;
        }
        #qrContainer {
            margin: 20px 0;
            min-height: 250px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background 0.3s;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #statusIndicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
        }
        .active { background: #4CAF50; }
        .inactive { background: #ff4444; }
        .security-warning {
            color: #ff4444;
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #ffcccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Class Attendance System</h1>
    
    <button id="toggleBtn">Start Attendance Session</button>
    <div id="statusIndicator" class="inactive" title="Session Status"></div>
    
    <div id="qrContainer"></div>
    
    <div class="security-warning">
        ‚ö†Ô∏è Security Note: Rotate the SECRET_PHRASE weekly and keep this page password protected!
    </div>

    <script>
        // =====================
        // CONFIGURATION
        // =====================
        const SECRET_PHRASE = 'SCHOOL_SECRET_2024'; // üîë CHANGE THIS MONTHLY
        const REFRESH_INTERVAL = 10000; // 10 seconds
        const VALIDITY_WINDOW = 15000; // 15 seconds
        
        // =====================
        // APP STATE
        // =====================
        let generationInterval = null;
        let currentSessionId = null;
        let lastGeneratedToken = null;

        // =====================
        // ELEMENTS
        // =====================
        const toggleBtn = document.getElementById('toggleBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const qrContainer = document.getElementById('qrContainer');

        // =====================
        // EVENT HANDLERS
        // =====================
        toggleBtn.addEventListener('click', toggleSession);

        function toggleSession() {
            if (!generationInterval) {
                startNewSession();
            } else {
                endCurrentSession();
            }
        }

        // =====================
        // CORE FUNCTIONS
        // =====================
        function startNewSession() {
            // Generate unique session ID
            currentSessionId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            
            // Initial generation
            generateNewQR();
            
            // Start interval
            generationInterval = setInterval(generateNewQR, REFRESH_INTERVAL);
            
            // Update UI
            toggleBtn.textContent = 'Stop Attendance Session';
            toggleBtn.style.background = '#ff4444';
            statusIndicator.className = 'active';
            
            // Broadcast session start to student apps
            updateSessionStatus(true);
        }

        function endCurrentSession() {
            clearInterval(generationInterval);
            generationInterval = null;
            currentSessionId = null;
            
            // Update UI
            toggleBtn.textContent = 'Start Attendance Session';
            toggleBtn.style.background = '#4CAF50';
            statusIndicator.className = 'inactive';
            qrContainer.innerHTML = '';
            
            // Broadcast session end
            updateSessionStatus(false);
        }

        function generateNewQR() {
            const timestamp = Math.floor(Date.now() / 10000);
            const payload = {
                t: timestamp,
                s: currentSessionId,
                h: simpleHash(timestamp + currentSessionId + SECRET_PHRASE)
            };

            const token = btoa(JSON.stringify(payload)).replace(/=/g, '');
            lastGeneratedToken = token;

            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: token,
                width: 250,
                height: 250,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // =====================
        // SECURITY HELPERS
        // =====================
        function simpleHash(str) {
            // Basic obfuscation (not cryptographic security)
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash << 5) - hash + str.charCodeAt(i);
                hash |= 0;
            }
            return hash.toString(36).slice(-8);
        }

        function updateSessionStatus(isActive) {
            // Store session status in GitHub (using gist)
            // Create a free GitHub gist and update this URL
            const GIST_URL = 'https://gist.githubusercontent.com/.../raw/';
            fetch(GIST_URL, {
                method: 'PUT',
                body: JSON.stringify({ active: isActive })
            }).catch(console.error);
        }
    </script>
</body>
</html>
