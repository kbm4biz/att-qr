<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الحضور الذكي</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <style>
        body {
            background-color: #e0f7fa; /* Light bluish background for easier scanning contrast */
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            text-align: center;
        }
        #qrContainer {
            margin: 20px 0;
            min-height: 250px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background 0.3s;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #statusIndicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
        }
        .active { background: #4CAF50; }
        .inactive { background: #ff4444; }
    </style>
</head>
<body>
    <h1>نظام الحضور الذكي</h1>
    
    <button id="toggleBtn">بدء جلسة الحضور</button>
    <div id="statusIndicator" class="inactive" title="حالة الجلسة"></div>
    
    <div id="qrContainer"></div>

    <!-- Optional: Include an audio alert when a session starts or ends -->
    <audio id="startSound" src="https://example.com/start-sound.mp3" preload="auto"></audio>
    <audio id="endSound" src="https://example.com/end-sound.mp3" preload="auto"></audio>

    <script>
        // =====================
        // CONFIGURATION
        // =====================
        const SECRET_PHRASE = 'SCHOOL_SECRET_2024'; // 🔑 CHANGE THIS MONTHLY
        const REFRESH_INTERVAL = 10000; // 10 seconds
        const VALIDITY_WINDOW_SECONDS = 30; // 30 seconds
        
        // =====================
        // APP STATE
        // =====================
        let generationInterval = null;
        let currentSessionId = null;
        let lastGeneratedToken = null;

        // =====================
        // ELEMENTS
        // =====================
        const toggleBtn = document.getElementById('toggleBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const qrContainer = document.getElementById('qrContainer');
        const startSound = document.getElementById('startSound');
        const endSound = document.getElementById('endSound');

        // =====================
        // EVENT HANDLERS
        // =====================
        toggleBtn.addEventListener('click', toggleSession);

        // =====================
        // CORE FUNCTIONS
        // =====================
        function toggleSession() {
            if (!generationInterval) {
                startNewSession();
            } else {
                endCurrentSession();
            }
        }

        function startNewSession() {
            // Generate unique session ID
            currentSessionId = generateSessionId();
            
            // Initial generation
            generateNewQR();
            
            // Start interval
            generationInterval = setInterval(generateNewQR, REFRESH_INTERVAL);
            
            // Update UI
            toggleBtn.textContent = 'إيقاف جلسة الحضور';
            toggleBtn.style.background = '#ff4444';
            statusIndicator.className = 'active';
            
            // Play start sound
            startSound.play().catch(err => console.error('Audio play error:', err));

            // Broadcast session start to student apps
            updateSessionStatus(true);
            
            console.log('جلسة الحضور بدأت. Session ID:', currentSessionId);
        }

        function endCurrentSession() {
            clearInterval(generationInterval);
            generationInterval = null;
            currentSessionId = null;
            
            // Update UI
            toggleBtn.textContent = 'بدء جلسة الحضور';
            toggleBtn.style.background = '#4CAF50';
            statusIndicator.className = 'inactive';
            qrContainer.innerHTML = '';
            
            // Play end sound
            endSound.play().catch(err => console.error('Audio play error:', err));
            
            // Broadcast session end
            updateSessionStatus(false);
            
            console.log('جلسة الحضور انتهت.');
        }

        function generateSessionId() {
            // Generate a unique session ID using current time and random characters
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function generateNewQR() {
            const timestamp = getSaudiTimestampSeconds(); // Unix timestamp in seconds
            const payload = {
                t: timestamp, // Unix timestamp in seconds
                s: currentSessionId,
                h: simpleHash(`${timestamp}${currentSessionId}${SECRET_PHRASE}`)
            };

            const token = btoa(JSON.stringify(payload)).replace(/=/g, '');
            lastGeneratedToken = token;

            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: token,
                width: 250,
                height: 250,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // For debugging: Log the payload
            console.log('Generated QR Payload:', payload);
        }

        // =====================
        // TIMEZONE HELPERS
        // =====================
        function getSaudiTime() {
            const now = new Date();
            // Convert current time to Saudi Arabia timezone
            const saudiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Riyadh' }));
            return saudiTime;
        }

        function getSaudiTimestampSeconds() {
            const saudiTime = getSaudiTime();
            return Math.floor(saudiTime.getTime() / 1000);
        }

        // =====================
        // SECURITY HELPERS
        // =====================
        function simpleHash(str) {
            // Basic obfuscation (not cryptographic security)
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash << 5) - hash + str.charCodeAt(i);
                hash |= 0;
            }
            return hash.toString(36).slice(-8);
        }

        function updateSessionStatus(isActive) {
            // Store session status in GitHub (using gist)
            // 🔑 Replace with your actual Gist URL
            const GIST_URL = 'https://gist.githubusercontent.com/your-username/your-gist-id/raw/'; 
            fetch(GIST_URL, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ active: isActive })
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Session status updated: ${isActive ? 'Active' : 'Inactive'}`);
                } else {
                    console.error('Failed to update session status.');
                }
            })
            .catch(error => {
                console.error('Error updating session status:', error);
            });
        }
    </script>
</body>
</html>
